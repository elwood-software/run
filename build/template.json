{
  "variables": {
    "region": "us-west-1",
    "source_ami": "ami-0ca1f30768d0cf0e1",
    "instance_type": "t2.micro"
  },
  "builders": [
    {
      "skip_create_ami": "true",
      "type": "amazon-ebs",
      "region": "{{user `region`}}",
      "source_ami": "{{user `source_ami`}}",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "instance_type": "{{user `instance_type`}}",
      "ssh_username": "{{user `ssh_username`}}",
      "ami_name": "elwood-run-{{timestamp}}",
      "tags":{
        "Name": "Elwood Run - {{timestamp}}"
      },
      "profile": ""
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "inline": [
        "cd ..",
        "zip source.zip build/*.sh src/**/* deno.lock deno.json"
      ]
    },
    {
      "type": "file",
      "source": "source.zip",
      "destination": "/tmp/source.zip"
    },
    {
      "type": "shell",
      "inline": [
        "yum -y install unzip",
        "mkdir -p /elwood/run-compiler",
        "unzip /tmp/source.zip -d /elwood/run-compiler",
        "cd /elwood/run-compiler",
        "./build/compile.sh",
        "mkdir -p /elwood/run/bin/",
        "mv runtime /elwood/run/bin/runtime",
        "./build/bootstrap.sh",
        "rm -r /elwood/run-compiler"
      ]
    }
  ]
}